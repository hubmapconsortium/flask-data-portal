{% extends 'pages/base.html' %}

{% block extra_stylesheets %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/searchkit/2.0.0/theme.css">
{% endblock %}

{% block title %}
  <h1 class="no-content">{% block title_text %}Search{% endblock %}</h1>
{% endblock %}

{% block content %}
<div id="search"></div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
<script src="https://unpkg.com/@hubmap/portal-search@v0.0.4/umd/@hubmap/portal-search.min.js"></script>

  <script>
    const commonFilters = [
      {
        type: 'RefinementListFilter',
        props: {
          id: 'organ',
          title: 'Organ',
          field: 'origin_sample.organ.keyword',
          operator: 'OR',
          size: 5,
          translations: {
            // From search-schema:
            BL: "Bladder",
            BR: "Brain",
            LB: "Bronchus (Left)",
            RB: "Bronchus (Right)",
            HT: "Heart",
            LK: "Kidney (Left)",
            RK: "Kidney (Right)",
            LI: "Large Intestine",
            LV: "Liver",
            LL: "Lung (Left)",
            RL: "Lung (Right)",
            LY01: "Lymph Node 01",
            LY02: "Lymph Node 02",
            LY03: "Lymph Node 03",
            LY04: "Lymph Node 04",
            LY05: "Lymph Node 05",
            LY06: "Lymph Node 06",
            LY07: "Lymph Node 07",
            LY08: "Lymph Node 08",
            LY09: "Lymph Node 09",
            LY10: "Lymph Node 10",
            LY11: "Lymph Node 11",
            LY12: "Lymph Node 12",
            LY13: "Lymph Node 13",
            LY14: "Lymph Node 14",
            LY15: "Lymph Node 15",
            LY16: "Lymph Node 16",
            LY17: "Lymph Node 17",
            LY18: "Lymph Node 18",
            LY19: "Lymph Node 19",
            LY20: "Lymph Node 20",
            SI: "Small Intestine",
            SP: "Spleen",
            TH: "Thymus",
            TR: "Trachea",
            UR: "Ureter",
            OT: "Other"
          }
        }
      },
      {
        type: 'RefinementListFilter',
        props: {
          id: 'specimen_type',
          title: 'Specimen Type',
          field: 'specimen_type.keyword',
          operator: 'OR',
          size: 5,
          translations: {
            // From search-schema:
            atacseq: 'ATACseq',
            biopsy: 'Biopsy',
            blood: 'Blood',
            cell_lysate: 'Cell lysate',
            clarity_hydrogel: 'CLARITY hydrogel',
            codex: 'CODEX',
            cryosections_curls_from_fresh_frozen_oct: 'Cryosections/curls from fresh frozen OCT',
            cryosections_curls_rnalater: 'Cryosectinos/curls RNAlater',
            ffpe_block: 'FFPE block',
            ffpe_slide: 'FFPE slide',
            fixed_frozen_section_slide: 'Fixed Frozen section slide',
            fixed_tissue_piece: 'Fixed tissue piece',
            flash_frozen_liquid_nitrogen: 'Flash frozen, liquid nitrogen',
            formalin_fixed_oct_block: 'Formalin fixed OCT block',
            fresh_frozen_oct_block: 'Fresh frozen oct block',
            fresh_frozen_section_slide: 'Fresh Frozen section slide',
            fresh_frozen_tissue: 'Fresh frozen tissue',
            fresh_frozen_tissue_section: 'Fresh Frozen Tissue Section',
            fresh_tissue: 'Fresh tissue',
            frozen_cell_pellet_buffy_coat: 'Frozen cell pellet (Buffy coat)',
            gdna: 'gDNA',
            module: 'Module',
            nuclei: 'Nuclei',
            nuclei_rnalater: 'Nuclei RNAlater',
            organ: 'Organ',
            organ_piece: 'Organ Piece',
            other: 'Other',
            pbmc: 'PBMC',
            pfa_fixed_frozen_oct_block: 'PFA Fixed frozen OCT block',
            plasma: 'Plasma',
            protein: 'Protein',
            ran_poly_a_enriched: 'RNA, poly-A enriched',
            rna_total: 'RNA, total',
            rnalater_treated_and_stored: 'RNAlater treated and stored',
            rnaseq: 'RNAseq',
            scatacseq: 'scATACseq',
            scrnaseq: 'scRNAseq',
            segment: 'Segment',
            seqfish: 'seqFISH',
            serum: 'Serum',
            single_cell_cryopreserved: 'Single cell cryopreserved',
            snatacseq: 'snATACseq',
            snrnaseq: 'snRNAseq',
            tissue_lysate: 'Tissue lysate',
            wgs: 'Whole Genome Sequencing'
          }
        }
      },
      {
        type: 'RefinementListFilter',
        props: {
          id: 'created_by_user_displayname',
          title: 'Creator',
          field: 'created_by_user_displayname.keyword',
          operator: 'OR',
          size: 5
        }
      },
      {
        type: 'RefinementListFilter',
        props: {
          id: 'contains_human_genetic_sequences',
          title: 'Contains genetic sequences',
          field: 'contains_human_genetic_sequences.keyword',
          operator: 'OR',
          size: 5
        }
      },
      {
        type: 'RefinementListFilter',
        props: {
          id: 'data_types',  // Not working?
          title: 'Data type',
          field: 'data_types.keyword',
          operator: 'OR',
          size: 5
        }
      },
      {
        type: 'RefinementListFilter',
        props: {
          id: 'donor_created_by',
          title: 'Donor created by',
          field: 'donor.created_by_user_displayname.keyword',
          operator: 'OR',
          size: 5
        }
      },
      {
        type: 'RefinementListFilter',
        props: {
          id: 'donor_group',
          title: 'Donor group',
          field: 'donor.group_name.keyword',
          operator: 'OR',
          size: 5
        }
      },
      {
        type: 'RefinementListFilter',
        props: {
          id: 'entity_type',
          title: 'Type',
          field: 'entity_type.keyword',
          operator: 'OR',
          size: 5
        }
      },
      {
        type: 'RefinementListFilter',
        props: {
          id: 'origin_sample_created_by',
          title: 'Organ created by',
          field: 'origin_sample.created_by_user_displayname.keyword',
          operator: 'OR',
          size: 5
        }
      },
      {
        type: 'RefinementListFilter',
        props: {
          id: 'source_sample_specimen_type',
          title: 'Specimen type',
          field: 'source_sample.specimen_type.keyword',
          operator: 'OR',
          size: 5
        }
      },
      {
        type: 'RefinementListFilter',
        props: {
          id: 'status',
          title: 'Status',
          field: 'status.keyword',
          operator: 'OR',
          size: 5
        }
      }
    ];
    const filtersByType = {
      '': commonFilters,
      donor: commonFilters,
      sample: commonFilters,
      dataset: commonFilters
    };
    const resultFieldsByType = {
      '': ['description', 'status', 'entity_type'],
      donor: ['description', 'status', 'entity_type'],
      sample: ['description', 'status', 'entity_type'],
      dataset: ['description', 'status', 'entity_type']
    }
    const type = (new URL(document.location).searchParams.get('entity_type[0]') || '').toLowerCase();
    hubmapPortalSearch.renderSearch(
      // ID of element to replace with search component:
      'search',
      {
        // Elasticsearch instance to hit with queries:
        apiUrl: '{{ elasticsearch_endpoint }}',
        // The default behavior is to add a "_search" path.
        // We don't want that.
        searchUrlPath: '',
        // Pass Globus token:
        httpHeaders: {
          'Authorization': 'Bearer ' + readCookie('nexus_token')
        },
        // Prefix for details links:
        detailsUrlPrefix: `/browse/${type || 'dataset'}/`,
        // Search results field which will be appended to detailsUrlPrefix:
        idField: 'uuid',
        // Search results fields to display in table:
        resultFields: resultFieldsByType[type],
        // Default hitsPerPage is 10:
        hitsPerPage: 20,
        // Sidebar facet configuration;
        // "type" should be one of the filters described here:
        // http://docs.searchkit.co/stable/components/navigation/
        filters: filtersByType[type]
      }
    );
  </script>
{% endblock %}
